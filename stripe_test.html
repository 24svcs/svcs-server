<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>Stripe Payment Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .payment-form {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #45a049;
      }
      .hidden {
        display: none;
      }
      #payment-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
      #card-element {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      #card-errors {
        color: #a94442;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Stripe Payment Test</h1>

    <div class="form-group">
      <label for="organization-id">Organization ID:</label>
      <input
        type="text"
        id="organization-id"
        placeholder="e.g. 1"
      />
    </div>

    <div class="form-group">
      <label for="invoice-uuid">Invoice UUID:</label>
      <input
        type="text"
        id="invoice-uuid"
        placeholder="e.g. 123e4567-e89b-12d3-a456-426614174000"
      />
    </div>

    <button id="get-payment-intent">Create Payment Intent</button>

    <div
      id="payment-form-container"
      class="payment-form hidden"
    >
      <h2>Make Payment</h2>
      <p id="payment-details"></p>

      <form id="payment-form">
        <div class="form-group">
          <label for="card-element">Credit or debit card</label>
          <div id="card-element">
            <!-- Stripe Element will be inserted here -->
          </div>
          <div
            id="card-errors"
            role="alert"
          ></div>
        </div>

        <button type="submit">Pay Now</button>
      </form>

      <div
        id="payment-result"
        class="hidden"
      ></div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      // Replace with your Stripe publishable key
      const stripePublishableKey =
        'pk_test_51RAVqURsv6V8EUp0mb07VTYU0UvBbAClSUDtXM2VeAjHIMGwa5WGf9rvTPJXaWaEIEdCkZIdeiAOH3TUGmmoHYJX00EHDdD4oI';

      // Replace with your API endpoint
      const apiBaseUrl = 'http://localhost:8000/api';

      // Initialize Stripe
      const stripe = Stripe(stripePublishableKey);
      const elements = stripe.elements();

      // Create card Element and mount it
      const cardElement = elements.create('card');

      let clientSecret = null;
      let paymentId = null;
      let invoiceNumber = null;
      let amount = 0;

      document.addEventListener('DOMContentLoaded', function () {
        const getPaymentIntentBtn =
          document.getElementById('get-payment-intent');
        const paymentForm = document.getElementById('payment-form');
        const paymentFormContainer = document.getElementById(
          'payment-form-container'
        );
        const paymentDetailsEl = document.getElementById('payment-details');
        const paymentResultEl = document.getElementById('payment-result');

        // Create Payment Intent button click handler
        getPaymentIntentBtn.addEventListener('click', async function () {
          const organizationId =
            document.getElementById('organization-id').value;
          const invoiceUuid = document.getElementById('invoice-uuid').value;

          if (!organizationId || !invoiceUuid) {
            alert('Please provide both Organization ID and Invoice UUID');
            return;
          }

          try {
            // Replace with your authentication token if needed
            const authToken = 'your_auth_token';

            // Create payment intent on server
            const response = await fetch(
              `${apiBaseUrl}/organizations/${organizationId}/stripe-payments/create-payment-intent/${invoiceUuid}/`,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                  return_url: window.location.href,
                }),
              }
            );

            if (!response.ok) {
              throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();

            // Save payment intent data
            clientSecret = data.client_secret;
            paymentId = data.payment_id;
            invoiceNumber = data.invoice_number;
            amount = data.amount;

            // Show payment form
            paymentFormContainer.classList.remove('hidden');

            // Mount the card Element
            cardElement.mount('#card-element');

            // Display payment details
            paymentDetailsEl.textContent = `Making payment of $${amount} for Invoice #${invoiceNumber}`;
          } catch (error) {
            console.error('Error creating payment intent:', error);
            alert(`Error creating payment intent: ${error.message}`);
          }
        });

        // Handle form submission
        paymentForm.addEventListener('submit', async function (event) {
          event.preventDefault();

          if (!clientSecret) {
            alert('No payment intent available. Please create one first.');
            return;
          }

          const { error, paymentIntent } = await stripe.confirmCardPayment(
            clientSecret,
            {
              payment_method: {
                card: cardElement,
                billing_details: {
                  name: 'Test Customer',
                },
              },
            }
          );

          if (error) {
            // Show error
            paymentResultEl.textContent = `Payment failed: ${error.message}`;
            paymentResultEl.className = 'error';
            paymentResultEl.classList.remove('hidden');
          } else if (paymentIntent.status === 'succeeded') {
            // Payment succeeded
            paymentResultEl.textContent = `Payment succeeded! Transaction ID: ${paymentIntent.id}`;
            paymentResultEl.className = 'success';
            paymentResultEl.classList.remove('hidden');
          }
        });
      });
    </script>
  </body>
</html>
